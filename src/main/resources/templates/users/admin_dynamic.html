<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    .sidebar { height: 100vh; width: 200px; position: fixed; }
    .sidebar .nav-link.active { background-color: #0d6efd; color: white; }
    .main-content { margin-left: 220px; padding: 20px; }
    body { padding-top: 56px; }
  </style>
</head>
<body>

<!-- Top Navbar -->
<nav class="navbar navbar-dark bg-dark fixed-top">
  <div class="container-fluid">
    <span class="navbar-text text-white" id="currentUser">Loading user...</span>
    <form action="/logout" method="post">
      <button type="submit" class="btn btn-outline-light">Logout</button>
    </form>
  </div>
</nav>

<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <nav class="col-md-2 d-none d-md-block bg-light sidebar">
      <div class="position-sticky pt-3">
        <ul class="nav flex-column mt-4">
          <li class="nav-item">
            <a href="#" class="nav-link active" id="adminTabLink">Admin</a>
          </li>
          <li class="nav-item">
            <a href="#" class="nav-link" id="userTabLink">User</a>
          </li>
        </ul>
      </div>
    </nav>

    <!-- Main content -->
    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content" id="contentArea">
      <!-- Admin Tabs -->
      <div id="adminContent">
        <h1 class="h2 mt-3 mb-3">Admin Panel</h1>
        <ul class="nav nav-tabs" id="adminTabs">
          <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="#usersTableTab">Users Table</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#newUserTab">New User</a>
          </li>
        </ul>

        <div class="tab-content mt-3">
          <!-- Users Table -->
          <div class="tab-pane fade show active" id="usersTableTab">
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Roles</th>
                  <th>Edit</th>
                  <th>Delete</th>
                </tr>
                </thead>
                <tbody id="usersTableBody"></tbody>
              </table>
            </div>
          </div>

          <!-- New User Form -->
          <div class="tab-pane fade" id="newUserTab">
            <form id="createUserForm">
              <div class="mb-3">
                <label for="newName" class="form-label">User Name</label>
                <input type="text" class="form-control" id="newName" required
                       pattern="^[a-zA-Z0-9_]{3,20}$"
                       title="Username must be 3-20 characters, letters, numbers or underscore">
              </div>
              <div class="mb-3">
                <label for="newEmail" class="form-label">Email</label>
                <input type="email" class="form-control" id="newEmail" required>
              </div>
              <div class="mb-3">
                <label for="newPassword" class="form-label">Password</label>
                <input type="password" class="form-control" id="newPassword" required minlength="3">
              </div>
              <div class="mb-3">
                <label for="newRoles" class="form-label">Roles</label>
                <select class="form-select" id="newRoles" multiple required>
                  <option value="ROLE_USER">USER</option>
                  <option value="ROLE_ADMIN">ADMIN</option>
                </select>
                <small class="text-muted">Hold Ctrl/Cmd to select multiple roles</small>
              </div>
              <button type="submit" class="btn btn-primary">Create User</button>
            </form>
          </div>
        </div>
      </div>

      <!-- User View (current user info) -->
      <div id="userContent" style="display:none;"></div>
    </main>
  </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="editUserForm">
        <div class="modal-header">
          <h5 class="modal-title">Edit User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editId">
          <div class="mb-3">
            <label class="form-label">Name</label>
            <input type="text" id="editName" class="form-control" required
                   pattern="^[a-zA-Z0-9_]{3,20}$"
                   title="Username must be 3-20 characters, letters, numbers or underscore">
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" id="editEmail" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Password (leave blank to keep)</label>
            <input type="password" id="editPassword" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Roles</label>
            <select id="editRoles" class="form-select" multiple required>
              <option value="ROLE_USER">USER</option>
              <option value="ROLE_ADMIN">ADMIN</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Save changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete User Modal -->
<div class="modal fade" id="deleteUserModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="deleteUserForm">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Delete</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="deleteId">
          <p>Are you sure you want to delete <span id="deleteUserName"></span>?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Delete</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  const apiUrl = '/api/users';

  // --- Sidebar tab switching ---
  document.addEventListener('DOMContentLoaded', () => {
    const adminLink = document.getElementById('adminTabLink');
    const userLink = document.getElementById('userTabLink');
    const adminContent = document.getElementById('adminContent');
    const userContent = document.getElementById('userContent');

    adminLink.addEventListener('click', e => {
      e.preventDefault();
      adminLink.classList.add('active');
      userLink.classList.remove('active');
      adminContent.style.display = 'block';
      userContent.style.display = 'none';
    });

    userLink.addEventListener('click', e => {
      e.preventDefault();
      userLink.classList.add('active');
      adminLink.classList.remove('active');
      adminContent.style.display = 'none';
      userContent.style.display = 'block';
      loadCurrentUser();
    });
  });

  // --- Load all users ---
  async function loadUsers() {
    const res = await fetch(apiUrl, { credentials: 'include' });
    const users = await res.json();
    const tbody = document.getElementById('usersTableBody');
    tbody.innerHTML = '';
    users.forEach(user => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
            <td>${user.id}</td>
            <td>${user.name}</td>
            <td>${user.email}</td>
            <td>${user.roleNamesString}</td>
            <td><button class="btn btn-info btn-sm" onclick="openEditModal(${user.id})">Edit</button></td>
            <td><button class="btn btn-danger btn-sm" onclick="openDeleteModal(${user.id})">Delete</button></td>
        `;
      tbody.appendChild(tr);
    });
  }

  // --- Load current user ---
  async function loadCurrentUser() {
    try {
      const res = await fetch(`${apiUrl}/currentUser`, { credentials: 'include' });
      if (!res.ok) throw new Error('Failed to fetch current user');
      const user = await res.json();
      document.getElementById('currentUser').textContent =
              `${user.email} with roles: ${user.roleNamesString}`;

      // Display table for this user
      document.getElementById('userContent').innerHTML = `
            <h1>User</h1>
            <table class="table table-bordered">
                <thead>
                    <tr><th>ID</th><th>Name</th><th>Email</th><th>Roles</th></tr>
                </thead>
                <tbody>
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>${user.roleNamesString}</td>
                    </tr>
                </tbody>
            </table>
        `;
    } catch(err) {
      console.error(err);
      document.getElementById('currentUser').textContent = 'Error loading user';
    }
  }

  // --- Edit User ---
  function openEditModal(id) {
    fetch(`${apiUrl}/${id}`, { credentials: 'include' })
            .then(res => res.json())
            .then(user => {
              document.getElementById('editId').value = user.id;
              document.getElementById('editName').value = user.name;
              document.getElementById('editEmail').value = user.email;
              document.getElementById('editPassword').value = '';
              const select = document.getElementById('editRoles');
              Array.from(select.options).forEach(opt => {
                opt.selected = user.roleNames.includes(opt.value.replace('ROLE_', ''));
              });
              new bootstrap.Modal(document.getElementById('editUserModal')).show();
            });
  }

  document.getElementById('editUserForm').addEventListener('submit', async e => {
    e.preventDefault();
    const id = document.getElementById('editId').value;
    const name = document.getElementById('editName').value;
    const email = document.getElementById('editEmail').value;
    const password = document.getElementById('editPassword').value;
    const roles = Array.from(document.getElementById('editRoles').selectedOptions).map(o => o.value);

    await fetch(`${apiUrl}/${id}`, {
      method:'PUT',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({name,email,password,roleNames:roles}),
      credentials: 'include'
    });
    bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
    loadUsers();
  });

  // --- Delete User ---
  function openDeleteModal(id) {
    fetch(`${apiUrl}/${id}`, { credentials: 'include' })
            .then(res => res.json())
            .then(user => {
              document.getElementById('deleteId').value = user.id;
              document.getElementById('deleteUserName').textContent = user.name;
              new bootstrap.Modal(document.getElementById('deleteUserModal')).show();
            });
  }

  document.getElementById('deleteUserForm').addEventListener('submit', async e => {
    e.preventDefault();
    const id = document.getElementById('deleteId').value;
    await fetch(`${apiUrl}/${id}`, { method:'DELETE', credentials: 'include' });
    bootstrap.Modal.getInstance(document.getElementById('deleteUserModal')).hide();
    loadUsers();
  });

  // --- Create User ---
  document.getElementById('createUserForm').addEventListener('submit', async e => {
    e.preventDefault();
    const name = document.getElementById('newName').value;
    const email = document.getElementById('newEmail').value;
    const password = document.getElementById('newPassword').value;
    const roles = Array.from(document.getElementById('newRoles').selectedOptions).map(o => o.value);

    await fetch(apiUrl, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({name,email,password,roleNames:roles}),
      credentials:'include'
    });
    document.getElementById('createUserForm').reset();
    loadUsers();
  });

  // --- Initial load ---
  document.addEventListener('DOMContentLoaded', () => {
    loadUsers();
    loadCurrentUser();
  });
</script>
</body>
</html>
