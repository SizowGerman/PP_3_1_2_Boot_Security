<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8">
  <title>Users Admin - Simple</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 18px; color: #111; }
    .container { display: flex; gap: 16px; align-items: flex-start; }
    .box { border: 1px solid #bbb; padding: 12px; width: 48%; }
    .box h2 { margin-top: 0; }
    label { display: block; margin: 8px 0 4px; font-weight: bold; }
    input[type="text"], input[type="email"], input[type="password"], input[type="number"] {
      width: 100%; padding: 6px; box-sizing: border-box; border: 1px solid #aaa;
    }
    .actions { margin-top: 10px; }
    button { padding: 6px 10px; }
    .hidden { display: none; }
    .selected-row { background: #eef; }
    .status { margin-top: 18px; border-top: 1px solid #ddd; padding-top: 10px; }
    .error { color: darkred; font-size: 12px; }
    table { width: 100%; border-collapse: collapse; margin-top:8px; }
    th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
    th { background: #f7f7f7; font-size: 12px; }
    .roles label { display:inline; margin-right: 12px; font-weight: normal; }
  </style>
</head>
<body>

<div class="container">
  <!-- ADD BOX -->
  <div class="box" aria-labelledby="addTitle">
    <h2 id="addTitle">Add New User</h2>

    <form th:action="@{/admin/add}" method="post" th:object="${user}">
      <label for="name">Name:</label>
      <input id="name" type="text" th:field="*{name}"
             pattern="[a-zA-Zа-яА-ЯёЁ\s\\-']+"
             required>
      <span th:if="${#fields.hasErrors('name')}" th:errors="*{name}" class="error"></span>

      <label for="email">Email:</label>
      <input id="email" type="email" th:field="*{email}" required>
      <span th:if="${#fields.hasErrors('email')}" th:errors="*{email}" class="error"></span>

      <label for="password">Password:</label>
      <input id="password" type="password" th:field="*{password}" minlength="6" required>
      <span th:if="${#fields.hasErrors('password')}" th:errors="*{password}" class="error"></span>

      <!-- Roles checkboxes -->
      <label>Roles:</label>
      <div class="roles">
        <label><input type="checkbox" th:field="*{roleNames}" value="ROLE_USER"> ROLE_USER</label>
        <label><input type="checkbox" th:field="*{roleNames}" value="ROLE_ADMIN"> ROLE_ADMIN</label>
      </div>

      <div class="actions">
        <button type="submit">Add User</button>
        <button type="reset">Reset</button>
      </div>
    </form>
  </div>

  <!-- MANAGE BOX -->
  <div class="box" aria-labelledby="manageTitle">
    <h2 id="manageTitle">Select & Modify User</h2>

    <!-- Search by ID -->
    <form id="searchForm" onsubmit="return false;">
      <label for="searchId">Search by User ID:</label>
      <input id="searchId" type="number" min="1" name="searchId">
      <div class="actions">
        <button type="button" id="findBtn">Find</button>
        <button type="button" id="clearBtn">Clear</button>
      </div>
    </form>

    <!-- User list -->
    <div>
      <table>
        <thead>
        <tr><th>ID</th><th>Name</th><th>Email</th><th>Action</th></tr>
        </thead>
        <tbody id="usersTbody">
        <tr th:each="u : ${users}" th:attr="data-id=${u.id}">
          <td th:text="${u.id}">1</td>
          <td th:text="${u.name}">Name</td>
          <td th:text="${u.email}">email@example.com</td>
          <td><button type="button" class="selectBtn" th:attr="data-id=${u.id}">Select</button></td>
        </tr>
        <tr th:if="${#lists.isEmpty(users)}">
          <td colspan="4">No users available.</td>
        </tr>
        </tbody>
      </table>
    </div>

    <!-- Edit form -->
    <div id="userManagementSection" class="hidden">
      <h3>Manage User ID: <span id="userIdDisplay"></span></h3>

      <form th:action="@{/admin/update}" method="post" id="editForm">
        <input type="hidden" name="id" id="editUserId">

        <label for="editName">Name:</label>
        <input id="editName" name="name" type="text"
               pattern="[a-zA-Zа-яА-ЯёЁ\\s\\-']+"
               required>
        <span id="editNameError" class="error"></span>

        <label for="editEmail">Email:</label>
        <input id="editEmail" name="email" type="email" required>
        <span id="editEmailError" class="error"></span>

        <label for="editPassword">Password: (leave empty if no change)</label>
        <input id="editPassword" name="password" type="password" minlength="4" placeholder="******">

        <!-- Roles checkboxes in edit -->
        <label>Roles:</label>
        <div class="roles">
          <label><input type="checkbox" name="roleNames" value="ROLE_USER" id="roleUser"> ROLE_USER</label>
          <label><input type="checkbox" name="roleNames" value="ROLE_ADMIN" id="roleAdmin"> ROLE_ADMIN</label>
        </div>

        <div class="actions">
          <button type="submit">Update User</button>
        </div>
      </form>

      <form th:action="@{/admin/delete}" method="post" style="margin-top:8px;">
        <input type="hidden" name="id" id="deleteUserId">
        <button type="submit" style="background-color: #ffcccc;">Delete User</button>
      </form>
    </div>
  </div>
</div>

<div class="status" id="selectionStatus">No user selected.</div>

<script th:inline="javascript">
  /*<![CDATA[*/
  const users = /*[[${users}]]*/ [];

  const userManagementSection = document.getElementById('userManagementSection');
  const userIdDisplay = document.getElementById('userIdDisplay');
  const editUserId = document.getElementById('editUserId');
  const deleteUserId = document.getElementById('deleteUserId');
  const editName = document.getElementById('editName');
  const editEmail = document.getElementById('editEmail');
  const editPassword = document.getElementById('editPassword');
  const roleUser = document.getElementById('roleUser');
  const roleAdmin = document.getElementById('roleAdmin');
  const selectionStatus = document.getElementById('selectionStatus');
  const usersTbody = document.getElementById('usersTbody');

  // clear selection visuals
  function clearSelectionVisuals() {
    usersTbody.querySelectorAll('tr').forEach(r => r.classList.remove('selected-row'));
  }

  // select user
  function selectUserById(id) {
    const u = users.find(x => Number(x.id) === Number(id));
    if (!u) { alert('User not found with ID: ' + id); return; }

    editUserId.value = u.id;
    deleteUserId.value = u.id;
    editName.value = u.name || '';
    editEmail.value = u.email || '';
    editPassword.value = '';

    // roles (assuming user.roles is an array of role strings)
    roleUser.checked = u.roles?.includes('ROLE_USER');
    roleAdmin.checked = u.roles?.includes('ROLE_ADMIN');

    userIdDisplay.textContent = u.id;
    userManagementSection.classList.remove('hidden');
    clearSelectionVisuals();
    const row = usersTbody.querySelector('tr[data-id=\"' + u.id + '\"]');
    if (row) row.classList.add('selected-row');
    selectionStatus.textContent = 'Selected user: ID ' + u.id + (u.name ? ' — ' + u.name : '');
  }

  // handle select buttons
  usersTbody.addEventListener('click', e => {
    const btn = e.target.closest('.selectBtn');
    if (!btn) return;
    selectUserById(btn.getAttribute('data-id'));
  });

  // find by ID
  document.getElementById('findBtn').addEventListener('click', () => {
    selectUserById(document.getElementById('searchId').value);
  });

  // clear
  document.getElementById('clearBtn').addEventListener('click', () => {
    document.getElementById('searchId').value = '';
    userManagementSection.classList.add('hidden');
    clearSelectionVisuals();
    selectionStatus.textContent = 'No user selected.';
  });
  /*]]>*/
</script>
</body>
</html>
